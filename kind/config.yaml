# Simulated EKS-like Kind cluster
# Save as kind-eks-sim.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4

# --- Networking configuration similar to EKS defaults ---
networking:
  # typical EKS pod/service ranges
  podSubnet: "10.100.0.0/16"
  serviceSubnet: "10.200.0.0/16"
  # change the apiServerAddress to your own IP just use 'ip addr' to locate your own ip otherwise this also works
  apiServerAddress: "0.0.0.0"
  apiServerPort: 6443
  disableDefaultCNI: false
  kubeProxyMode: "iptables"

# --- Node configuration ---
nodes:
  # Control plane/Master Node
  - role: control-plane
    image: kindest/node:v1.34.0
    extraPortMappings:
      - containerPort: 80
        hostPort: 80
        protocol: TCP
      - containerPort: 443
        hostPort: 443
        protocol: TCP
    kubeadmConfigPatches:
      - |
        kind: ClusterConfiguration
        apiServer:
          extraArgs:
            authorization-mode: "Node,RBAC"
            enable-admission-plugins: "NodeRestriction"
        controllerManager:
          extraArgs:
            enable-hostpath-provisioner: "true"

  # Worker nodes
  - role: worker
    image: kindest/node:v1.34.0
    labels:
      eks.amazonaws.com/nodegroup: "ng-1"
      topology.kubernetes.io/zone: "us-east-1a"
    kubeadmConfigPatches:
      - |
        kind: KubeletConfiguration
        cgroupDriver: systemd
  - role: worker
    image: kindest/node:v1.34.0
    labels:
      eks.amazonaws.com/nodegroup: "ng-2"
      topology.kubernetes.io/zone: "us-east-1b"
    kubeadmConfigPatches:
      - |
        kind: KubeletConfiguration
        cgroupDriver: systemd
#  - role: worker
#    image: kindest/node:v1.34.0
#    labels:
#      eks.amazonaws.com/nodegroup: "ng-3"
#      topology.kubernetes.io/zone: "us-east-1c"
#    kubeadmConfigPatches:
#      - |
#        kind: KubeletConfiguration
#        cgroupDriver: systemd 

# --- Optional container runtime configuration ---
containerdConfigPatches:
  - |
    [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
      runtime_type = "io.containerd.runc.v2"
      [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
        SystemdCgroup = true
